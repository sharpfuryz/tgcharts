(function(){'use strict';var a=Math.min,b=Math.round,c=Math.ceil,d=Math.max;const e=(a,b)=>a.map(a=>a[b]),f=a=>a.reduce((c,a)=>d(c,a)),g=(a,b)=>{if(a.length<=b)return a;else{const d=[];for(let e=0;e<b;e++){const f=c(b/100*e*a.length);d.push(a[f])}return d}},h=(a,b,c)=>b<a&&a<c,i=(a,b,c,d=1.05)=>{const g=c.map(a=>e(b,a)).flat(),h=f(g);return a/(h*d)};class j{constructor(a){this.chartInstance=a;const{chartElement:b,svgElement:c,controlsElement:d,previewElement:e}=a;this.chartElement=b,this.svgElement=c,this.bindChartEvents(),this.chart={mousedown:!1},d&&(this.controlsElement=d),a.preview&&(this.previewElement=e,this.bindPreviewEvents(),this.preview={dragLeft:!1,dragCenter:!1,dragRight:!1,prevX:0})}bindChartEvents(){this.svgElement.addEventListener("mousemove",this.onChartMouseMove.bind(this),!1),this.svgElement.addEventListener("mouseout",this.onChartMouseOut.bind(this),!1),this.svgElement.addEventListener("touchstart",this.onChartMouseMove.bind(this),!1),this.svgElement.addEventListener("touchmove",this.onChartMouseMove.bind(this),!1),this.svgElement.addEventListener("touchcancel",this.onChartMouseOut.bind(this),!1)}onChartMouseMove(a){a.preventDefault();const{layerX:c}=a,{from:d,to:e,selected:f}=this.chartInstance.window,g=this.chartElement.clientWidth/(e-d),h=b(c/g);h!==f&&this.updateWindow({selected:h})}onChartMouseOut(){this.updateWindow({selected:-1})}validateWindowAttributes(a){let{from:b,to:c}=a;return b&&(1>b&&(b=1),a.from=b),c&&(c<=b&&(c=b+1),c>this.chartInstance.ticks.length&&(c=this.chartInstance.ticks.length-1)),a}updateWindow(a){const b=this.validateWindowAttributes(a),c=Object.assign({},this.chartInstance.window,b);this.chartInstance.onWindowUpdate(c)}onPreviewMouseDown(a){a.preventDefault();const{layerX:b}=a,{isLeftHandle:c,isCenter:d,isRightHandle:e}=this.isMouseOnHandle(b);(c||d||e)&&(this.setPreviewCursor(!0),c&&(this.preview.dragLeft=!0),e&&(this.preview.dragRight=!0),d&&(this.preview.dragCenter=!0))}isMouseOnHandle(a){const b=this.chartInstance.window.from/this.chartInstance.ticks.length,c=this.chartInstance.window.to/this.chartInstance.ticks.length,d=this.chartElement.clientWidth*b,e=this.chartElement.clientWidth*c,f=h(a,d-this.chartInstance.styles.frame.left,d),g=h(a,e-this.chartInstance.styles.frame.right,e),i=h(a,d,e-this.chartInstance.styles.frame.right);return{isLeftHandle:f,isRightHandle:g,isCenter:i}}setPreviewCursor(a){this.previewElement.style.cursor=a?"move":"default"}onPreviewMouseUp(){this.preview.dragLeft&&(this.preview.dragLeft=!1,this.setPreviewCursor(!1)),this.preview.dragRight&&(this.preview.dragRight=!1,this.setPreviewCursor(!1)),this.preview.dragCenter&&(this.preview.dragCenter=!1,this.setPreviewCursor(!1))}onPreviewMouseMove(c){var e=Math.abs;const{layerX:f}=c;if(this.preview.dragLeft||this.preview.dragRight||this.preview.dragCenter){if(this.preview.dragLeft){const c=f/this.previewElement.clientWidth,e=b(this.chartInstance.ticks.length*c),g=d(e,1),h=a(this.chartInstance.window.to-1,g);this.updateWindow({from:h})}if(this.preview.dragRight){const c=f/this.previewElement.clientWidth,e=b(this.chartInstance.ticks.length*c),g=a(e,this.chartInstance.ticks.length),h=d(this.chartInstance.window.from+1,g);this.updateWindow({to:h})}if(this.preview.dragCenter){const c=this.previewElement.clientWidth/this.chartInstance.ticks.length;if(this.preview.prevX){const g=this.preview.prevX,h=e(g-f),i=b(h/c);if(0<i)if(f<g){const b=d(this.chartInstance.window.from-i,1),c=a(this.chartInstance.window.to-i,this.chartInstance.ticks.length);this.updateWindow({from:b,to:c})}else{const b=d(this.chartInstance.window.from+i,1),c=a(this.chartInstance.window.to+i,this.chartInstance.ticks.length);this.updateWindow({from:b,to:c})}}this.preview.prevX=f}}else{const{isLeftHandle:a,isCenter:b,isRightHandle:c}=this.isMouseOnHandle(f);a||c||b?this.setPreviewCursor(!0):this.setPreviewCursor(!1)}}onPreviewMouseOut(){this.preview.dragLeft=!1,this.preview.dragRight=!1,this.preview.dragCenter=!1,delete this.preview.prevX,this.setPreviewCursor(!1)}bindPreviewEvents(){this.previewElement.addEventListener("mousedown",this.onPreviewMouseDown.bind(this),!1),this.previewElement.addEventListener("mouseup",this.onPreviewMouseUp.bind(this),!1),this.previewElement.addEventListener("mousemove",this.onPreviewMouseMove.bind(this),!1),this.previewElement.addEventListener("mouseout",this.onPreviewMouseOut.bind(this),!1),this.previewElement.addEventListener("touchstart",this.onPreviewMouseDown.bind(this),!1),this.previewElement.addEventListener("touchend",this.onPreviewMouseUp.bind(this),!1),this.previewElement.addEventListener("touchmove",this.onPreviewMouseMove.bind(this),!1),this.previewElement.addEventListener("touchcancel",this.onPreviewMouseOut.bind(this),!1)}}const k=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],l=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],m=a=>{const b=new Date(a),c=k[b.getMonth()],d=b.getUTCDate();return`${c} ${d}`},n=a=>{const b=new Date(a),c=k[b.getMonth()],d=b.getUTCDate(),e=l[b.getDay()];return`${e}, ${c} ${d}`},o={tick:{y:6,x:6,lineColor:"rgba(242,244,245, 1)",labelColor:"rgba(152,162,169, 1)",padding:3},paddings:{bottom:50},circle:6,tooltip:{lineColor:"rgba(224, 230, 234, 0.8)",width:135,height:94},frame:{left:7,right:7,top:3,bottom:3,borderColor:"rgba(221,234,243, 0.8)",outerColor:"rgba(245,249,251, 0.7)"},controls:{height:50,lineColor:"rgba(242,244,245, 1)",paddingLeft:10}},p=22,q=70,r="http://www.w3.org/2000/svg",s=a=>{for(;a.lastChild;)a.removeChild(a.lastChild)},t=(a,b,c,d)=>{const e=v(a,d);b.forEach(a=>{const{text:b,x:d,y:f}=a;u(b,d,f,e,c)})},u=(a,b,c,d,e,f)=>{const g=document.createElementNS(r,"text");g.setAttributeNS(null,"font-family","Helvetica, Arial"),g.setAttributeNS(null,"x",b),g.setAttributeNS(null,"y",c),e&&g.setAttributeNS(null,"fill",e),f&&g.setAttributeNS(null,"font-weight",f);const h=document.createTextNode(a);g.appendChild(h),d.appendChild(g)},v=(a,b)=>{const c=document.createElementNS(r,"g");return c.setAttribute("id",a),b.appendChild(c),c},w=(a,b)=>{const c=document.createElementNS(r,"rect");return Object.keys(a).forEach(b=>{c.setAttributeNS(null,b,a[b])}),c.classList.add("chart__tooltip--shadow"),b.appendChild(c),c},z=(a,b,c)=>{let d=a-c/2;return a<c&&(d=10),a+c>b&&(d=b-c-10),d},A=(a,b,c,d,e,f,g,h)=>{const{centerX:i,y:j}=a,k=v("tooltip",h),l=j.length*q+15,m=z(i,g,l),n={x:m,y:3,width:l,height:70,rx:10,ry:10,stroke:b.lineColor,fill:"#fff"};w(n,k);const o=d[c.from+c.selected];o&&B(o,m,e,f,k)},B=(a,b,c,d,e)=>{const f=n(a.x);u(f,b+15,p,e,"#333"),Object.keys(a).filter(a=>"x"!=a).forEach((f,g)=>{const h=c[f],i=d[f],j=a[f],k=b+15+q*g;u(j,k,2*p,e,h,"bold"),u(i,k,3*p,e,h)})},C=()=>{const b=a(window.screen.width,window.innerWidth,920)-20;return document.getElementById("holder").style.width=`${b}px`,b},D=(a,d)=>{const e=900<window.screen.width,f=e?c(d/2):d,g=b(d/8),h=H(a),i=E(h,`chart_${a}`,"chart",d,f),j=F(h,`chart_scale_${a}`,"chart_svg",d,f),k=E(h,`chart_${a}_mini`,"chart_preview",d,g),l=G(h,`chart_interactive_${a}`,"chart_controls",d,60);return{chartElement:i,svgElement:j,previewElement:k,controlsElement:l}},E=(a,b,c,d,e)=>{const f=document.createElement("canvas");return f.classList.add(c),f.id=b,f.width=d,f.height=e,document.body.appendChild(f),a.appendChild(f),f},F=(a,b,c,d,e)=>{const f=document.createElementNS("http://www.w3.org/2000/svg","svg");return f.classList.add(c),f.setAttribute("width",d),f.setAttribute("height",e),f.setAttribute("id",b),document.body.appendChild(f),a.appendChild(f),f},G=(a,b,c,d,e)=>{const f=document.createElement("div");return f.classList.add(c),f.id=b,f.style.width=`${d}px`,f.style.height=`${e}px`,document.body.appendChild(f),a.appendChild(f),f},H=a=>{const b=document.createElement("div");return b.id=`holder_${a}`,b.classList.add("chart_holder"),document.body.appendChild(b),document.getElementById("holder").appendChild(b),b},I=(a,b,c,d,e,f,g)=>{const h=`${a}_checkbox_${c}`,i=document.createElement("div");i.classList.add("chart_controls__checkbox"),g.appendChild(i);const j=document.createElement("input");j.setAttribute("type","checkbox"),j.setAttribute("checked",!0),j.setAttribute("id",h),j.addEventListener("click",()=>{!0===j.checked?e(b):f(b)}),i.appendChild(j);const k=document.createElement("label");k.innerText=c,k.setAttribute("for",h),i.appendChild(k);const l=document.createElement("div");l.classList.add("chart_controls__checkbox__circle"),l.style.backgroundColor=d,i.appendChild(l)};CanvasRenderingContext2D.prototype.roundRect=function(a,b,c,d,e){return c<2*e&&(e=c/2),d<2*e&&(e=d/2),this.beginPath(),this.moveTo(a+e,b),this.arcTo(a+c,b,a+c,b+d,e),this.arcTo(a+c,b+d,a,b+d,e),this.arcTo(a,b+d,a,b,e),this.arcTo(a,b,a+c,b,e),this.closePath(),this};class J{constructor({chartId:a,chartElement:b,svgElement:c,previewElement:d,controlsElement:e}){this.styles=o,this.chartId=a,this.svgElement=c,this.chartElement=b,this.previewElement=d,this.controlsElement=e,this.preview=this.previewElement,this.absoluteBounds={min:0,max:0},this.state={changed:!0,renderTicks:[],tickHeight:0,ticksY:[],ticksX:[]},this.mouseCapture=new j(this)}setData({colors:a,columns:c,names:d,types:e}){this.colors=a,this.columns=c,this.dataColumns=this.columns.filter(a=>"x"!==a[0]),this.names=d,this.types=e,this.ticks=this.convertTicks(),this.activeAxis=Object.keys(this.ticks[0]).filter(a=>"x"!==a),this.window={from:b(.9*this.ticks.length),selected:-1,to:b(.95*this.ticks.length)},this.calculateState()}render(){requestAnimationFrame(()=>{this.selection={centerX:0,y:[]},this.renderChart(),this.renderPreview(),this.renderSVG()})}renderChart(){const{clientHeight:a,clientWidth:b}=this.chartElement,c=this.window.to-this.window.from,d=this.chartElement.getContext("2d");d.clearRect(0,0,b,a);const{renderTicks:e,tickHeight:f}=this.state;this.renderAxisTicks({context:d,ticks:e,clientHeight:a,clientWidth:b}),this.activeAxis.forEach(g=>{const h=e.map(a=>a[g]);this.drawLine({context:d,color:this.colors[g],lineWidth:4,lineCap:"round",tickWidth:b/c,tickHeight:f,clientHeight:a-this.styles.paddings.bottom,items:h,start:0})}),0<=this.window.selected&&this.renderSelectionLine({context:d,clientHeight:a-this.styles.paddings.bottom})}renderSVG(){const{clientWidth:a}=this.chartElement;s(this.svgElement),t("axisY",this.state.ticksY,this.styles.tick.labelColor,this.svgElement),t("axisX",this.state.ticksX,this.styles.tick.labelColor,this.svgElement),0<=this.window.selected&&A(this.selection,this.styles.tooltip,this.window,this.ticks,this.colors,this.names,a,this.svgElement)}onAxisEnable(a){this.activeAxis.includes(a)||this.activeAxis.push(a),this.render()}onAxisDisable(a){this.activeAxis=this.activeAxis.filter(b=>b!==a),this.render()}renderControls(){s(this.controlsElement),Object.keys(this.names).forEach(a=>{const b=this.names[a],c=this.colors[a];I(this.chartId,a,b,c,this.onAxisEnable.bind(this),this.onAxisDisable.bind(this),this.controlsElement)})}renderAxisTicks({context:a,ticks:b,clientHeight:d,clientWidth:e}){const{tick:f,paddings:h}=this.styles,i=f.y,j=(d-h.bottom)/i;this.state.ticksY=[],this.state.ticksX=[];for(let g=0;g<i;g++){const b=c(this.absoluteBounds.max*g/10),d=j*(i-g);this.state.ticksY.push({text:b,x:f.padding,y:d-10}),a.beginPath(),a.strokeStyle=f.lineColor,a.lineWidth=1,a.moveTo(f.padding,d),a.lineTo(e-f.padding,d),a.closePath(),a.stroke()}const k=g(b,f.x).map(a=>a.x),l=e/k.length;for(let c=0;c<=k.length;c++){const a=m(k[c]),b=l*c+3*(2*this.styles.tick.padding);this.state.ticksX.push({text:a,x:b,y:d-25})}}drawLine({context:a,color:b,lineWidth:c,lineCap:d,tickWidth:e,tickHeight:f,clientHeight:g,items:h,start:i=1}){a.beginPath(),a.strokeStyle=b,a.lineWidth=c||1,a.lineCap=d||"butt",a.beginPath(),h.forEach((b,c)=>{if(c>=i){const d=c*e,h=g-b*f;c===i&&a.moveTo(0,h),c===this.window.selected?(a.lineTo(d-this.styles.circle,h),a.closePath(),a.stroke(),a.beginPath(),this.selection.centerX=d,this.selection.y.push(h),a.arc(d,h,this.styles.circle,0,2*Math.PI),a.moveTo(d+this.styles.circle,h),a.stroke()):(a.lineTo(d,h),a.moveTo(d,h))}}),a.closePath(),a.stroke()}onWindowUpdate(d){const e=this.window.from===d.from,a=this.window.to===d.to,b=this.window.selected===d.selected;this.state.changed=!(e&&a&&b),this.state.changed&&(this.window=d,this.calculateState()),this.render()}calculateState(){const a=this.chartElement.clientHeight-this.styles.paddings.bottom;this.state.renderTicks=this.getVisibleTicks(),this.state.tickHeight=i(a,this.state.renderTicks,this.activeAxis),this.state.changed=!1}getVisibleTicks(){return this.ticks.filter((a,b)=>b>=this.window.from&&b<=this.window.to)}renderSelectionLine({context:a,clientHeight:b}){if(this.selection.centerX){const{circle:c,tooltip:d}=this.styles,{centerX:e}=this.selection,f=c+2;a.lineWidth=1,a.strokeStyle=this.styles.tooltip.lineColor,a.beginPath(),a.moveTo(e,b);const g=this.selection.y.sort().reverse();g.forEach((b,c,d)=>{a.lineTo(e,b+f),a.closePath(),a.stroke(),a.beginPath(),a.moveTo(e,b-f);const g=d[c+1];g||(a.lineTo(e,0),a.closePath(),a.stroke())})}}convertTicks(){const b={},c=[],e={};return this.columns.forEach(c=>{const f=c[0];"x"===f?c.forEach((a,c)=>b[c]={x:a}):(e[f]={min:0,max:0},c.forEach((c,g)=>{0<g&&(e[f].min=a(e[f].min,c),e[f].max=d(e[f].max,c)),b[g][f]=c}))}),Object.keys(b).map(a=>c.push(b[a])),this.calculateAbsoluteBounds(e),c}calculateAbsoluteBounds(b){let c=0,e=0;Object.keys(b).map(f=>{const{min:g,max:h}=b[f];e=d(e,h),c=a(c,g)}),this.absoluteBounds={min:c,max:e}}renderPreview(){const{clientHeight:a,clientWidth:b}=this.previewElement,c=b/this.ticks.length,d=a/this.absoluteBounds.max,e=this.previewElement.getContext("2d");e.clearRect(0,0,b,a),this.dataColumns.forEach(b=>{const f=b[0];this.drawLinePreview({context:e,color:this.colors[f],clientHeight:a,tickHeight:d,tickWidth:c,items:b})}),this.renderPreviewFrame({context:e,clientWidth:b,clientHeight:a})}renderPreviewFrame({context:a,clientWidth:b,clientHeight:c}){const d=this.window.from/this.ticks.length,e=this.window.to/this.ticks.length,f=b*d,g=b*e;a.fillStyle=this.styles.frame.outerColor,a.fillRect(0,0,f,c),a.fillRect(g,0,b,c),a.fillStyle=this.styles.frame.borderColor,a.fillRect(f-this.styles.frame.left,0,this.styles.frame.left,c),a.fillRect(g-this.styles.frame.right,0,this.styles.frame.right,c);const h=g-f;a.fillRect(f,0,h,this.styles.frame.top),a.fillRect(f,c-this.styles.frame.bottom,h,this.styles.frame.bottom)}drawLinePreview({context:a,color:b,tickWidth:c,tickHeight:d,clientHeight:e,items:f}){a.beginPath(),a.strokeStyle=b,a.lineWidth=1,a.lineCap="butt";const g=1;f.forEach((b,f)=>{if(f>=g){const h=f*c,i=e-b*d;f==g&&a.moveTo(0,i),a.lineTo(h,i),a.moveTo(h,i)}}),a.closePath(),a.stroke()}}document.addEventListener("DOMContentLoaded",(async()=>{const a=await fetch("/chart_data.json"),b=await a.json(),c=C();b.forEach((a,b)=>{const{chartElement:d,svgElement:e,previewElement:f,controlsElement:g}=D(b,c),h=new J({chartId:b,chartElement:d,svgElement:e,previewElement:f,controlsElement:g});h.setData(a),h.render(),h.renderControls()})})())})();
